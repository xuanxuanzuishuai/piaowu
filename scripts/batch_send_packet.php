<?php
/**
 * Created by PhpStorm.
 * User: lizao
 * Date: 2020/11/04
 * Time: 18:10
 */

namespace App;

date_default_timezone_set('PRC');
set_time_limit(0);
define('PROJECT_ROOT', realpath(__DIR__ . '/..'));
define('APP_ROOT', PROJECT_ROOT . '/app');
define('TEMP_ROOT', APP_ROOT . '/Templates');
define('LANG_ROOT', PROJECT_ROOT . '/lang');

// require composer autoload
require_once PROJECT_ROOT . '/vendor/autoload.php';

use App\Libs\Erp;
use App\Libs\Exceptions\RunTimeException;
use App\Libs\MysqlDB;
use App\Libs\SimpleLogger;
use App\Models\EmployeeModel;
use App\Models\StudentModel;
use App\Models\WeChatAwardCashDealModel;
use App\Services\ErpReferralService;
use Dotenv\Dotenv;

$dotenv = new Dotenv(PROJECT_ROOT, '.env');
$dotenv->load();
$dotenv->overload();


// 40元红包手机号列表：
$mobileList40 = [
    '13318999428',
    '13855189763',
    '13379864683',
    '13976006156',
    '13433248663',
    '18800525958',
    '13438855853',
    '13309770871',
    '13480540528',
    '13804547915',
    '13511084350',
    '18266505703',
    '13530098023',
    '18621864265',
    '13548597680',
    '15204660312',
    '13565303811',
    '13852942855',
    '13570423427',
    '15102309127',
    '13593709676',
    '18995192264',
    '13594302901',
    '13637072568',
    '13653453150',
    '13667981739',
    '13683159714',
    '13705977252',
    '13787113550',
    '13817069328',
    '13828482626',
    '13835428447',
    '13859556328',
    '13882296397',
    '13915696511',
    '13925181903',
    '13941049551',
    '13974901572',
    '13989632310',
    '15002230533',
    '15035703322',
    '15044160077',
    '15139354000',
    '15301132950',
    '15371815856',
    '15553605157',
    '15834188778',
    '15921000361',
    '15926170918',
    '17390093311',
    '18055433508',
    '18229000232',
    '18270501993',
    '18396093371',
    '18610595775',
    '18638468690',
    '18640046628',
    '18697231112',
    '18729338108',
    '18755401083',
    '18966601083',
    '13134943081',
    '13249624429',
    '13393089106',
    '13647308666',
    '15977600309',
    '18628865955',
    '18660768266',
    '13993007789',
    '18523827790',
    '18554370060',
    '18612771857',
    '18811049108',
    '18832628680',
    '13729007057',
    '13810085961',
    '18643768628',
    '13022850359',
    '13235626346',
    '13305413898',
    '13503535160',
    '13601836309',
    '13605554567',
    '13626481264',
    '13675873721',
    '13701358587',
    '13703181217',
    '13760015111',
    '13777458298',
    '13788111818',
    '13888668697',
    '13942629186',
    '13978277286',
    '15074874266',
    '15152233643',
    '15268256735',
    '15385838000',
    '15810482528',
    '15855462351',
    '15949488779',
    '17735202639',
    '18523158197',
    '18752596365',
    '18798006608',
    '18912253399',
    '13084595589',
    '13359223141',
    '13522852205',
    '13854253948',
    '18999959636',
    '13637909213',
    '13892729889',
    '18249079555',
    '18951059905',
    '18955780604',
    '13610105737',
    '13624434917',
    '13653717872',
    '13916280345',
    '15295562980',
    '15524755756',
    '15987508071',
    '18703068196',
    '13231405768',
    '13834966798',
    '15964139421',
    '18811064394',
    '18129537315',
    '13922983532',
    '18936607755',
    '13705350287',
    '13560431759',
    '15361466023',
    '18518672120',
    '18923838168',
    '15245963561',
    '15364735176',
    '15274375755',
    '18610882106',
    '18616133353',
    '15160062832',
    '15026977947',
    '13641695609',
    '15387511883',
    '15155166558',
    '18936038310',
    '13940018629',
    '13063236452',
    '15555822755',
    '13923451153',
    '13559233383',
    '15201976261',
    '18977912829',
    '15504938900',
    '18925318109',
    '15050691249',
    '18339569998',
    '18748210996',
    '13998516848',
    '13681923109',
    '13568160299',
    '13933500263',
    '13814786877',
    '13757100789',
    '15612106779',
    '17323477187',
    '18704695470',
    '13613513738',
];

// 50元红包手机号列表：
$mobileList50 = [
    '13150756170',
    '13196223068',
    '13206367370',
    '13706250974',
    '13345626595',
    '13819218518',
    '13392526106',
    '13963296368',
    '13402628248',
    '18679196161',
    '13411348901',
    '18843583988',
    '13524822113',
    '13683727595',
    '13633674431',
    '13536427183',
    '13671695477',
    '13892845253',
    '13733675978',
    '13987275073',
    '13735479148',
    '15259133685',
    '13751875885',
    '18790293290',
    '13774262207',
    '18905901433',
    '13775216012',
    '13392496626',
    '13798553906',
    '13805010129',
    '13810303896',
    '13888654745',
    '13889842853',
    '13908634597',
    '13917382550',
    '13946013137',
    '13966106963',
    '13982020004',
    '13997335590',
    '15005771561',
    '15170880015',
    '15174999009',
    '15834393167',
    '15847953657',
    '15889639022',
    '15955510489',
    '17788016097',
    '18184672518',
    '18192862624',
    '18397748810',
    '18605104117',
    '18612186258',
    '18622464008',
    '18623655151',
    '18650905607',
    '18659578080',
    '18677777760',
    '18700767279',
    '18701897959',
    '18809209091',
    '18825171096',
    '18851611697',
    '695590852',
    '13685136926',
    '15291684259',
    '15866129818',
    '18080485476',
    '18331835811',
    '18602800419',
    '18789421929',
    '13715136001',
    '13807607843',
    '15920105472',
    '13580801265',
    '13772597251',
    '13904210952',
    '13959205315',
    '15274382261',
    '15950187991',
    '17709990058',
    '13326322099',
    '15011222466',
    '18211710707',
    '13307718986',
    '13399638096',
    '13402668339',
    '13421308624',
    '13523565900',
    '13543999330',
    '13567426593',
    '13569329384',
    '13583219201',
    '13589859086',
    '13693663661',
    '13717717714',
    '13784600517',
    '13807538914',
    '13838492988',
    '13859994862',
    '13976566866',
    '15114998876',
    '15124945119',
    '15283818653',
    '15345607655',
    '15645011892',
    '15698940688',
    '15907076163',
    '15921741621',
    '15953950711',
    '17764830909',
    '18007888199',
    '18017856499',
    '18055270282',
    '18059731289',
    '18192700503',
    '18620396250',
    '18626661663',
    '18686088683',
    '18911701058',
    '18932632964',
    '18947720228',
    '18969866636',
    '15383908996',
    '15905588581',
    '13099952196',
    '13831825701',
    '15088595307',
    '18680768523',
    '15162765657',
    '13931723339',
    '13114909818',
    '13505912724',
    '13509563001',
    '13735378711',
    '13828890504',
    '15145131793',
    '18077118693',
    '13133718380',
    '13416572494',
    '13426316520',
    '13799422804',
    '15146164521',
    '17768372906',
    '18039070106',
    '18971082912',
    '13537864362',
    '13733186449',
    '13308410840',
    '18726958575',
    '13373239899',
    '13731500992',
    '18019007511',
    '15089696559',
    '15890054861',
    '18254281358',
    '18395025678',
    '13671221253',
    '13435556348',
    '16651611409',
    '18678680215',
    '15866838049',
    '18914690328',
    '13620992380',
    '13927811231',
    '15906379819',
    '17352930736',
    '17767125037',
    '18128787427',
    '13567251279',
    '18007087213',
    '13702286085',
    '13755864973',
    '13811554673',
    '15165922731',
    '15855256394',
    '13803954662',
    '13868586006',
];
$taskId = 231;
foreach ($mobileList40 as $mobile) {
    sendPacket($taskId, $mobile);
    usleep(200);
}

$taskId = 232;
foreach ($mobileList50 as $mobile) {
    sendPacket($taskId, $mobile);
    usleep(200);
}
function sendPacket($taskId, $mobile)
{
    if (empty($taskId) || empty($mobile)) {
        SimpleLogger::info("empty data", [$taskId, $mobile]);
        return;
    }
    $db = MysqlDB::getDB();
    // 查询学生uuid
    $studentInfo = $db->queryAll("SELECT `uuid` FROM ".StudentModel::$table." WHERE `mobile`='".$mobile."' LIMIT 1;");
    if (empty($studentInfo[0]['uuid'])) {
        SimpleLogger::info("student not found", [$mobile]);
        return;
    }
    try {
        // 完成任务
        $awardInfo = (new Erp())->updateTask($studentInfo[0]['uuid'], $taskId, ErpReferralService::EVENT_TASK_STATUS_COMPLETE);
        SimpleLogger::info("Send Info", [$studentInfo, $taskId, $awardInfo]);
        if (empty($awardInfo['data']['user_award_ids'])) {
            return;
        }

        // 发奖
        $res = ErpReferralService::updateAward(
            $awardInfo['data']['user_award_ids'][0],
            ErpReferralService::AWARD_STATUS_GIVEN,
            EmployeeModel::SYSTEM_EMPLOYEE_ID,
            '',
            WeChatAwardCashDealModel::REISSUE_PIC_WORD
        );
        SimpleLogger::info("Send Result", [$res]);
        return;
    } catch (RunTimeException $e) {
        SimpleLogger::error("Send Error", [$e->getMessage()]);
        return false;
    }
}